if(loggedIn){let e=document.getElementById("auth-btn");e.setAttribute("href","javascript:void(0);"),document.getElementById("auth-btn").innerText="Log Out",e.addEventListener("click",logout),"admin"===userRole&&document.getElementById("user-menu").insertAdjacentHTML("beforeend",'<li><a href="admin-panel.html"><i class="fa fa-star"></i> Admin</a></li>')}else document.querySelector(".header-down").innerHTML="",document.querySelector("#chat-circle").remove(),document.querySelector(".chat-box").remove(),document.getElementById("auth-btn").innerText="Log In";window.addEventListener("load",async()=>{try{document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",'<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12" id="loader">\n              <div id="loader" class="loader"></div>\n            </div>');const e=await fetch(`${baseURL}/get_active_tutors`,{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();if(t.data.activeTutors.length>0){document.querySelector("#loader").remove();for(let e=0;e<t.data.activeTutors.length;e++)document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",`<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12">\n                <div class="tutor-content">\n                  <img src=${t.data.activeTutors[e].image} alt="">\n                  <span>${t.data.activeTutors[e].name}</span>\n                </div>\n              </div>`)}else document.querySelector("#loader").remove(),document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",'<div class="col-lg-8">\n              <div class="alert alert-info text-center">\n                <strong>There are currently no active tutors in the system</strong>\n              </div>\n            </div>')}catch(e){console.error(e)}if(loggedIn){try{document.querySelector("#groups").insertAdjacentHTML("beforeend",'<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12" id="loader">\n              <div class="loader"></div>\n            </div>');const e=await fetch(`${baseURL}/groups`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),t=await e.json();if(200!==e.status)window.alert(t.message);else if(document.getElementById("loader").remove(),t.data.groups.length>0)for(let e=0;e<t.data.groups.length;e++)groupIds.push(t.data.groups[e]._id),document.querySelector("#groups").insertAdjacentHTML("beforeend",`<div class="friend" id="group ${t.data.groups[e]._id}">\n                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                <p>\n                    <strong>${t.data.groups[e].title}</strong><br>\n                    <span>${t.data.groups[e].members.length} members</span>\n                </p>\n                <div id="status-${t.data.groups[e]._id}"></div>\n            </div>`);document.querySelector("#private").insertAdjacentHTML("beforeend",'<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12" id="loader">\n              <div class="loader"></div>\n            </div>');const s=await fetch(`${baseURL}/get_conversations`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),a=await s.json();if(200!==s.status)window.alert(a.message);else{document.getElementById("loader").remove();for(let e=0;e<a.data.filteredConversations.length;e++)conversationIds.push(a.data.filteredConversations[e]._id),document.querySelector("#private").insertAdjacentHTML("beforeend",`<div class="friend" id="${a.data.filteredConversations[e]._id}">\n                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                <p>\n                    <strong>${a.data.filteredConversations[e].name}</strong><br>\n                    <span>${a.data.filteredConversations[e].email}</span>\n                </p>\n                <div id="status-${a.data.filteredConversations[e]._id}"></div>\n            </div>`);socket.emit("loggedIn",{groupIds:groupIds,userId:userId,conversationIds:conversationIds})}}catch(e){console.error(e)}document.getElementById("searchfield").addEventListener("keyup",async t=>{if("Enter"===t.key){const t=document.getElementById("searchfield").value,s=await fetch(`${baseURL}/search_users?searchQuery=${t}`);if(200===s.status){const t=await s.json();for(let e=0;e<t.data.users.length;e++)t.data.users[e]._id===userId||document.getElementById(t.data.users[e]._id)||document.querySelector("#private").insertAdjacentHTML("beforeend",`<div class="friend" id="${t.data.users[e]._id}">\n                      <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                      <p>\n                          <strong>${t.data.users[e].name}</strong><br>\n                          <span>${t.data.users[e].email}</span>\n                      </p>\n                      <div id="status-${t.data.users[e]._id}"></div>\n                    </div>`);e()}}});const e=()=>{let e=$(".friend");for(let t=0;t<e.length;t++){let a=e[t],n=$(e[t]);n.click(async()=>{let e=n.offset(),t=n.parent().parent().offset(),o=e.top-t.top,d=n.find("img").eq(0).clone(),r=`${o+12}px`;$(d).css({top:r}).addClass("floatingImg").appendTo("#chatbox"),setTimeout(()=>{$("#profile p").addClass("animate"),$("#profile").addClass("animate")},100),setTimeout(()=>{$("#chat-messages").addClass("animate"),$(".cx, .cy").addClass("s1"),setTimeout(()=>{$(".cx, .cy").addClass("s2")},100),setTimeout(()=>{$(".cx, .cy").addClass("s3")},100)},150),$(".floatingImg").animate({width:"68px",left:"108px",top:"20px"},200);let i=n.find("p strong").html(),c=n.find("p span").html();$("#profile p").html(i),$("#profile span").html(c),$(".message").not(".right").find("img").attr("src",$(d).attr("src")),$("#friendslist").fadeOut(),$("#chatview").fadeIn(),$("#close").unbind("click").click(()=>{$("#chat-messages, #profile, #profile p").removeClass("animate"),$(".cx, .cy").removeClass("s1 s2 s3"),$(".floatingImg").animate({width:"40px",top:r,left:"12px"},200,()=>{$(".floatingImg").remove()}),setTimeout(()=>{$("#chatview").fadeOut(),$("#friendslist").fadeIn()})});let m=a.getAttribute("id"),l=null;if(m.includes("group")){m=null,l=a.getAttribute("id").split(" ")[1];try{const e=await fetch(`${baseURL}/group_messages?groupId=${l}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),t=await e.json();if(200!==e.status)window.alert(t.message);else{document.querySelector("#chat-messages").innerHTML="";for(let e=0;e<t.data.messages.messages.length;e++){if(0===e&&document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<label>${moment(new Date(t.data.messages.messages[e].createdAt).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").format("MMMM Do YYYY")}</label>`),e>0){new Date(t.data.messages.messages[e].createdAt).getDay()-new Date(t.data.messages.messages[e-1].createdAt).getDay()>=1&&document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<label>${moment(new Date(t.data.messages.messages[e].createdAt).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").format("MMMM Do YYYY")}</label>`)}s({from:t.data.messages.messages[e].from,id:t.data.messages.messages[e]._id,message:t.data.messages.messages[e].message,time:t.data.messages.messages[e].createdAt})}document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",'<div class="upload__files"></div>')}}catch(e){console.error(e)}}else try{const e=await fetch(`${baseURL}/messages?users=${m}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),t=await e.json();if(200!==e.status)window.alert(t.message);else{document.querySelector("#chat-messages").innerHTML="";for(let e=0;e<t.data.messages.length;e++){if(0===e&&document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<label>${moment(new Date(t.data.messages.messages[e].createdAt).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").format("MMMM Do YYYY")}</label>`),e>0){new Date(t.data.messages.messages[e].createdAt).getDay()-new Date(t.data.messages.messages[e-1].createdAt).getDay()>=1&&document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<label>${moment(new Date(t.data.messages.messages[e].createdAt).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").format("MMMM Do YYYY")}</label>`)}s({from:t.data.messages[e].from._id,id:t.data.messages[e]._id,message:t.data.messages[e].message,time:t.data.messages[e].createdAt})}document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",'<div class="upload__files"></div>')}}catch(e){console.error(e)}document.getElementById("send-message-input").addEventListener("keyup",()=>{null==m?socket.emit("typing",{room:l,userId:userId}):socket.emit("typing",{room:userId+m,userId:userId})});const u=async()=>{let e=document.querySelector("#send-message-input").value;const t=document.querySelector("#file").files;if(document.querySelector("#send-message-input").value="",e.trim().length>0){e=e.trim();const a=new FormData,n=[];if(t.length>0)for(let e=0;e<t.length;e++)n.push(t[e]);document.querySelector(".upload__files").remove(),s({from:userId,id:"processing-msg",message:e,time:(new Date).getTime()}),document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",'<div class="upload__files"></div>');try{let t;if(null==m){const s=[l];a.append("to[]",s[0]),a.append("message",e),a.append("groupId",l),a.append("files[]",n),t=await fetch(`${baseURL}/message`,{method:"POST",headers:{Authorization:`Bearer ${token}`},body:a})}else a.append("to",m),a.append("message",e),t=await fetch(`${baseURL}/message`,{method:"POST",headers:{Authorization:`Bearer ${token}`},body:a});if(201===t.status){const e=await t.json();null==m?document.querySelector("#processing-msg").remove():document.querySelector("#processing-msg").setAttribute("id",e.data.message._id)}}catch(e){console.error(e)}}};document.getElementById("sendmessage").addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),u())}),document.getElementById("send").addEventListener("click",u)})}};e(),socket.on("typing",e=>{document.getElementById("typing")||e===userId||(document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",'<div class="message" id="typing">\n                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                <div class="bubble">\n                    <div class="ticontainer">\n                        <div class="tiblock">\n                            <div class="tidot"></div>\n                            <div class="tidot"></div>\n                            <div class="tidot"></div>\n                        </div>\n                    </div>\n                </div>\n              </div>'),setTimeout(()=>{document.getElementById("typing").remove()},5e3))}),socket.on("message",e=>{"send"===e.action&&(document.getElementById("typing")&&document.getElementById("typing").remove(),s({from:e.message.from,id:e.message._id,message:e.message.message,time:e.message.createdAt}))}),socket.on("message",e=>{"delete"===e.action&&document.getElementById(e.message)&&document.getElementById(e.message).remove()}),socket.on("online",e=>{document.querySelector(`#status-${e.user}`)&&document.querySelector(`#status-${e.user}`).classList.add("status");for(let t=0;t<e.groups.length;t++)document.querySelector(`#status-${e.groups[t]}`)&&document.querySelector(`#status-${e.groups[t]}`).classList.add("status")}),socket.on("offline",e=>{document.querySelector(`#status-${e.user}`)&&document.querySelector(`#status-${e.user}`).classList.remove("status");for(let t=0;t<e.groups.length;t++)document.querySelector(`#status-${e.groups[t]}`)&&document.querySelector(`#status-${e.groups[t]}`).classList.remove("status")});const t=()=>{const e=document.getElementsByClassName("remove-mes");Array.prototype.filter.call(e,e=>{e.addEventListener("click",async()=>{const t=e.id.split("-")[2];try{document.getElementById(t).classList.add("processing-msg"),200===(await fetch(`${baseURL}/message/${t}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}})).status&&document.getElementById(t).remove()}catch(e){console.error(e)}})})},s=({from:e,id:s,message:a,time:n})=>{document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<div class="message ${e===userId?"right":""}" id="${s}">\n            <div class="chat-img">\n               <img src="" alt="">\n            </div>\n\x3c!--            <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />--\x3e\n            <div class="bubble">\n              ${a}\n              <div id="time-tool">${moment(new Date(n).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").format("h:mm a")}</div>\n              ${e===userId?`<div class="remove-mes" id="remove-mes-${s}"><a href="javascript:void(0);"><i class="fa fa-trash"></i></a></div>`:""}\n            </div>\n          </div>`),t(),$("#chat-messages").animate({scrollTop:$("#chat-messages")[0].scrollHeight},2e3)}}});
