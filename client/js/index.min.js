if(loggedIn){let e=document.getElementById("auth-btn");e.setAttribute("href","javascript:void(0);"),document.getElementById("auth-btn").innerText="Log Out",e.addEventListener("click",logout)}else document.querySelector(".header-down").innerHTML="",document.querySelector("#chat-circle").remove(),document.querySelector(".chat-box").remove(),document.getElementById("auth-btn").innerText="Log In";window.addEventListener("load",async()=>{try{document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",'<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12" id="loader">\n              <div class="loader"></div>\n            </div>');const e=await fetch(`${baseURL}/get_tutors`,{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();if(t.data.tutors.length>0)for(let e=0;e<t.data.tutors.length;e++)document.querySelector("#loader").remove(),document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",`<div class="col-lg-4 col-md-4 col-sm-6 col-xs-12">\n                <div class="tutor-content">\n                  <img src="images/tutor.jpg" alt="">\n                  <span>${t.data.tutors[0].name}</span>\n                </div>\n              </div>`);else document.querySelector("#loader").remove(),document.querySelector("#tutors-list").insertAdjacentHTML("beforeend",'<div class="col-lg-8">\n              <div class="alert alert-info text-center">\n                <strong>There are currently no tutors in the system</strong>\n              </div>\n            </div>')}catch(e){console.error(e)}if(loggedIn){try{const e=await fetch(`${baseURL}/groups`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),t=await e.json();if(200!==e.status)window.alert(t.message);else if(t.data.groups.length>0)for(let e=0;e<t.data.groups.length;e++)groupIds.push(t.data.groups[e]._id),document.querySelector("#groups").insertAdjacentHTML("beforeend",`<div class="friend" id="group ${t.data.groups[e]._id}">\n                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                <p>\n                    <strong>${t.data.groups[e].title}</strong><br>\n                    <span>${t.data.groups[e].members.length} members</span>\n                </p>\n                <div class="status"></div>\n            </div>`);const s=await fetch(`${baseURL}/get_conversations`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),a=await s.json();if(200!==s.status)window.alert(a.message);else{for(let e=0;e<a.data.filteredConversations.length;e++)conversationIds.push(a.data.filteredConversations[e]._id),document.querySelector("#private").insertAdjacentHTML("beforeend",`<div class="friend" id="${a.data.filteredConversations[e]._id}">\n                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n                <p>\n                    <strong>${a.data.filteredConversations[e].name}</strong><br>\n                    <span>${a.data.filteredConversations[e].email}</span>\n                </p>\n                <div id="status-${a.data.filteredConversations[e]._id}"></div>\n            </div>`);socket.emit("loggedIn",{groupIds:groupIds,userId:userId,conversationIds:conversationIds})}}catch(e){console.error(e)}let e=$(".friend");for(let s=0;s<e.length;s++){let a=e[s],o=$(e[s]);o.click(async()=>{let e=o.offset(),s=o.parent().parent().offset(),n=e.top-s.top,r=o.find("img").eq(0).clone(),i=`${n+12}px`;$(r).css({top:i}).addClass("floatingImg").appendTo("#chatbox"),setTimeout(()=>{$("#profile p").addClass("animate"),$("#profile").addClass("animate")},100),setTimeout(()=>{$("#chat-messages").addClass("animate"),$(".cx, .cy").addClass("s1"),setTimeout(()=>{$(".cx, .cy").addClass("s2")},100),setTimeout(()=>{$(".cx, .cy").addClass("s3")},100)},150),$(".floatingImg").animate({width:"68px",left:"108px",top:"20px"},200);let d=o.find("p strong").html(),c=o.find("p span").html();$("#profile p").html(d),$("#profile span").html(c),$(".message").not(".right").find("img").attr("src",$(r).attr("src")),$("#friendslist").fadeOut(),$("#chatview").fadeIn(),$("#close").unbind("click").click(()=>{$("#chat-messages, #profile, #profile p").removeClass("animate"),$(".cx, .cy").removeClass("s1 s2 s3"),$(".floatingImg").animate({width:"40px",top:i,left:"12px"},200,()=>{$(".floatingImg").remove()}),setTimeout(()=>{$("#chatview").fadeOut(),$("#friendslist").fadeIn()})});let l=a.getAttribute("id"),m=null;if(l.includes("group")){l=null,m=a.getAttribute("id").split(" ")[1];try{const e=await fetch(`${baseURL}/group_messages?groupId=${m}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),s=await e.json();if(200!==e.status)window.alert(s.message);else{document.querySelector("#chat-messages").innerHTML="";for(let e=0;e<s.data.messages.messages.length;e++)t({from:s.data.messages.messages[e].from,id:s.data.messages.messages[e]._id,message:s.data.messages.messages[e].message,time:s.data.messages.messages[e].createdAt})}}catch(e){console.error(e)}}else try{const e=await fetch(`${baseURL}/messages?users=${l}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`}}),s=await e.json();if(200!==e.status)window.alert(s.message);else{document.querySelector("#chat-messages").innerHTML="";for(let e=0;e<s.data.messages.length;e++)t({from:s.data.messages[e].from._id,id:s.data.messages[e]._id,message:s.data.messages[e].message,time:s.data.messages[e].createdAt})}}catch(e){console.error(e)}const g=async()=>{const e=document.querySelector("#send-message-input").value.trim();if(document.querySelector("#send-message-input").value="",e.length>0){t({from:userId,id:"processing-msg",message:e,time:(new Date).getTime()});try{let t;if(201===(t=null==l?await fetch(`${baseURL}/message`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({to:[m],message:e,groupId:m})}):await fetch(`${baseURL}/message`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({to:[l],message:e})})).status){const e=await t.json();null==l?document.querySelector("#processing-msg").remove():document.querySelector("#processing-msg").setAttribute("id",e.data.message._id)}}catch(e){console.error(e)}}};document.getElementById("send-message-input").addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g())}),document.getElementById("send").addEventListener("click",g)})}socket.on("message",e=>{"send"===e.action&&t({from:e.message.from,id:e.message._id,message:e.message.message,time:e.message.createdAt})}),socket.on("online",e=>{document.querySelector(`#status-${e}`)&&document.querySelector(`#status-${e}`).classList.add("status")}),socket.on("offline",e=>{document.querySelector(`#status-${e}`)&&document.querySelector(`#status-${e}`).classList.remove("status")});const t=({from:e,id:t,message:s,time:a})=>{document.querySelector("#chat-messages").insertAdjacentHTML("beforeend",`<div class="message ${e===userId?"right":""}" id="${t}">\n            <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />\n            <div class="bubble">\n              ${s}\n              <div class="corner"></div>\n              <span>${moment(new Date(a).toDatetimeLocal().toString(),"YYYYMMDDhhmmss").fromNow()}</span>\n            </div>\n          </div>`)}}});